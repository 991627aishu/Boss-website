<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Duplicate Subject and Table Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .content-display { 
            white-space: pre-line; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.4;
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 10px 5px; 
            cursor: pointer; 
            border-radius: 5px;
        }
        button:hover { background: #45a049; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>Test Duplicate Subject and Table Fix</h1>
    <p>This test verifies that:</p>
    <ul>
        <li>‚úÖ No duplicate subject lines appear</li>
        <li>‚úÖ Table data shows in the preview</li>
        <li>‚úÖ Content structure is correct</li>
    </ul>
    
    <div>
        <button onclick="testChessByPanchatantra()">Test "Chess By Panchatantra" (Like Your Image)</button>
        <button onclick="testWithTable()">Test with Table Data</button>
        <button onclick="testWithoutTable()">Test without Table</button>
    </div>
    
    <div id="status"></div>
    
    <div class="test-section">
        <h3>Test Results:</h3>
        <div id="test-results" class="content-display">Click a test button to see the results...</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const testResultsDiv = document.getElementById('test-results');
        
        function log(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(message);
        }
        
        function analyzeContent(content, testName) {
            const analysis = [];
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            
            analysis.push(`=== ${testName} Analysis ===`);
            analysis.push("");
            
            // Check 1: Subject line count (should be only one)
            const subjectLines = lines.filter(line => line.toLowerCase().includes('subject:'));
            if (subjectLines.length === 1) {
                analysis.push("‚úÖ PASS: Only one subject line found");
            } else {
                analysis.push(`‚ùå FAIL: Found ${subjectLines.length} subject lines (should be 1)`);
            }
            
            // Check 2: No duplicate content
            const requestCount = (content.match(/Request for approval regarding/g) || []).length;
            if (requestCount === 1) {
                analysis.push("‚úÖ PASS: Single request paragraph (no duplicates)");
            } else {
                analysis.push(`‚ùå FAIL: ${requestCount} request paragraphs found (should be 1)`);
            }
            
            // Check 3: Table presence
            const hasTableTitle = content.includes('Financial/Resource Implications Table:');
            const hasTableData = content.includes('\t') && (content.match(/\t/g) || []).length > 3;
            
            if (hasTableTitle && hasTableData) {
                analysis.push("‚úÖ PASS: Table data is present in preview");
            } else if (hasTableTitle) {
                analysis.push("‚ö†Ô∏è WARNING: Table title found but no tab-separated data");
            } else {
                analysis.push("‚ùå FAIL: No table data found in preview");
            }
            
            // Check 4: Content structure
            const hasSubject = content.includes('Subject:');
            const hasRequest = content.includes('Request for approval regarding');
            const hasBullets = content.includes('‚Ä¢');
            const hasConclusion = content.includes('The above proposal is submitted for approval');
            const hasSignatures = content.includes('Dr Phani Kumar Pullela');
            
            let structureScore = 0;
            if (hasSubject) structureScore++;
            if (hasRequest) structureScore++;
            if (hasBullets) structureScore++;
            if (hasConclusion) structureScore++;
            if (hasSignatures) structureScore++;
            
            analysis.push(`‚úÖ PASS: Content structure complete (${structureScore}/5 components)`);
            
            // Check 5: No content mixing
            const hasChessContent = content.toLowerCase().includes('chess');
            const hasTeacherContent = content.toLowerCase().includes('teacher');
            const hasPanchatantraContent = content.toLowerCase().includes('panchatantra');
            
            if (testName.includes('Chess') && hasChessContent) {
                analysis.push("‚úÖ PASS: Chess content matches test subject");
            } else if (testName.includes('Teacher') && hasTeacherContent) {
                analysis.push("‚úÖ PASS: Teacher content matches test subject");
            } else {
                analysis.push("‚ö†Ô∏è WARNING: Content may not match test subject");
            }
            
            // Overall assessment
            const passCount = (analysis.join('\n').match(/‚úÖ PASS/g) || []).length;
            const failCount = (analysis.join('\n').match(/‚ùå FAIL/g) || []).length;
            const warnCount = (analysis.join('\n').match(/‚ö†Ô∏è WARNING/g) || []).length;
            
            analysis.push("");
            analysis.push(`=== OVERALL ASSESSMENT ===`);
            analysis.push(`Passed: ${passCount} requirements`);
            analysis.push(`Failed: ${failCount} requirements`);
            analysis.push(`Warnings: ${warnCount} issues`);
            
            if (failCount === 0 && warnCount === 0) {
                analysis.push("üéâ PERFECT: All requirements met!");
            } else if (failCount === 0) {
                analysis.push("‚úÖ GOOD: All requirements met, minor warnings");
            } else if (failCount <= 1) {
                analysis.push("‚ö†Ô∏è ACCEPTABLE: Most requirements met");
            } else {
                analysis.push("‚ùå NEEDS IMPROVEMENT: Multiple requirements failed");
            }
            
            return analysis.join('\n');
        }
        
        async function testChessByPanchatantra() {
            try {
                log("üîÑ Testing 'Chess By Panchatantra' (like your image)...", 'info');
                
                const requestData = {
                    subject: "Chess By Panchatantra",
                    summary: "Chess tournament organized by Panchatantra club on 5th September 2025 at RV University Campus. The event will feature competitive chess matches among students and faculty, promoting strategic thinking and community engagement through chess activities.",
                    nfaType: "reimbursement",
                    bulletsRequired: true,
                    tableData: [
                        ["slno", "item", "unit", "total"],
                        ["1", "prize", "2", "20"],
                        ["2", "prize", "2", "20"],
                        ["3", "prize", "2", "20"],
                        ["Total", "", "", "60"]
                    ]
                };
                
                console.log("üì§ Sending Chess By Panchatantra request:", requestData);
                
                const response = await fetch('http://localhost:5000/api/generate-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                
                const result = await response.json();
                console.log("üì• Chess By Panchatantra response:", result);
                
                if (result.success) {
                    const content = result.nfaText || "";
                    const analysis = analyzeContent(content, "Chess By Panchatantra");
                    
                    testResultsDiv.textContent = `Generated Content:\n${content}\n\n--- ANALYSIS ---\n\n${analysis}`;
                    
                    // Overall assessment
                    const passCount = (analysis.match(/‚úÖ PASS/g) || []).length;
                    const failCount = (analysis.match(/‚ùå FAIL/g) || []).length;
                    const warnCount = (analysis.match(/‚ö†Ô∏è WARNING/g) || []).length;
                    
                    if (failCount === 0 && warnCount === 0) {
                        log(`üéâ Chess By Panchatantra PERFECT: ${passCount} requirements met`, 'success');
                    } else if (failCount === 0) {
                        log(`‚úÖ Chess By Panchatantra GOOD: ${passCount} passed, ${warnCount} warnings`, 'success');
                    } else if (failCount <= 1) {
                        log(`‚ö†Ô∏è Chess By Panchatantra ACCEPTABLE: ${passCount} passed, ${failCount} failed`, 'warning');
                    } else {
                        log(`‚ùå Chess By Panchatantra NEEDS IMPROVEMENT: ${passCount} passed, ${failCount} failed`, 'error');
                    }
                    
                } else {
                    throw new Error(result.error || "Chess By Panchatantra generation failed");
                }
                
            } catch (error) {
                log(`‚ùå Error testing Chess By Panchatantra: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function testWithTable() {
            try {
                log("üîÑ Testing with table data...", 'info');
                
                const requestData = {
                    subject: "Workshop on AI",
                    summary: "Technical workshop on Artificial Intelligence and Machine Learning for 100 students with expert speakers and hands-on training sessions.",
                    nfaType: "advance",
                    bulletsRequired: true,
                    tableData: [
                        ["slno", "item", "unit", "total"],
                        ["1", "speaker fees", "2", "10000"],
                        ["2", "venue", "1", "5000"],
                        ["3", "materials", "100", "3000"],
                        ["Total", "", "", "18000"]
                    ]
                };
                
                const response = await fetch('http://localhost:5000/api/generate-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const content = result.nfaText || "";
                    const analysis = analyzeContent(content, "Workshop with Table");
                    
                    testResultsDiv.textContent = `Generated Content:\n${content}\n\n--- ANALYSIS ---\n\n${analysis}`;
                    
                    const passCount = (analysis.match(/‚úÖ PASS/g) || []).length;
                    const failCount = (analysis.match(/‚ùå FAIL/g) || []).length;
                    const warnCount = (analysis.match(/‚ö†Ô∏è WARNING/g) || []).length;
                    
                    if (failCount === 0 && warnCount === 0) {
                        log(`üéâ Workshop with Table PERFECT: ${passCount} requirements met`, 'success');
                    } else if (failCount === 0) {
                        log(`‚úÖ Workshop with Table GOOD: ${passCount} passed, ${warnCount} warnings`, 'success');
                    } else {
                        log(`‚ö†Ô∏è Workshop with Table: ${passCount} passed, ${failCount} failed`, 'warning');
                    }
                    
                } else {
                    throw new Error(result.error || "Workshop generation failed");
                }
                
            } catch (error) {
                log(`‚ùå Error testing with table: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function testWithoutTable() {
            try {
                log("üîÑ Testing without table data...", 'info');
                
                const requestData = {
                    subject: "Sports Event",
                    summary: "Annual sports event featuring various competitions among students to promote physical fitness and teamwork.",
                    nfaType: "reimbursement",
                    bulletsRequired: false,
                    tableData: []
                };
                
                const response = await fetch('http://localhost:5000/api/generate-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const content = result.nfaText || "";
                    const analysis = analyzeContent(content, "Sports Event without Table");
                    
                    testResultsDiv.textContent = `Generated Content:\n${content}\n\n--- ANALYSIS ---\n\n${analysis}`;
                    
                    const passCount = (analysis.match(/‚úÖ PASS/g) || []).length;
                    const failCount = (analysis.match(/‚ùå FAIL/g) || []).length;
                    const warnCount = (analysis.match(/‚ö†Ô∏è WARNING/g) || []).length;
                    
                    if (failCount === 0 && warnCount === 0) {
                        log(`üéâ Sports Event PERFECT: ${passCount} requirements met`, 'success');
                    } else if (failCount === 0) {
                        log(`‚úÖ Sports Event GOOD: ${passCount} passed, ${warnCount} warnings`, 'success');
                    } else {
                        log(`‚ö†Ô∏è Sports Event: ${passCount} passed, ${failCount} failed`, 'warning');
                    }
                    
                } else {
                    throw new Error(result.error || "Sports Event generation failed");
                }
                
            } catch (error) {
                log(`‚ùå Error testing without table: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        // Auto-run health check on page load
        window.onload = () => {
            setTimeout(() => {
                log("üîÑ Testing server health...", 'info');
                fetch('http://localhost:5000/api/health')
                    .then(response => response.json())
                    .then(result => {
                        log(`‚úÖ Health check: ${JSON.stringify(result)}`, 'success');
                    })
                    .catch(error => {
                        log(`‚ùå Health check failed: ${error.message}`, 'error');
                    });
            }, 1000);
        };
    </script>
</body>
</html>
