<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DOCX Download</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #1565c0;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test DOCX Download Functionality</h1>
        <p>This page tests the fixed DOCX download functionality to ensure files download as .docx instead of .txt</p>
        
        <div>
            <button onclick="testPythonDownload()">Test Python-Generated DOCX</button>
            <button onclick="testClientSideDownload()">Test Client-Side DOCX</button>
            <button onclick="testExistingFile()">Test Existing DOCX File</button>
            <button onclick="debugPythonScript()">Debug Python Script</button>
        </div>
        
        <div id="status"></div>
        
        <div class="info">
            <h3>Test Instructions:</h3>
            <ol>
                <li>Click "Test Python-Generated DOCX" to test the FIXED Python script workflow</li>
                <li>Click "Test Client-Side DOCX" to test the fallback client-side generation</li>
                <li>Click "Test Existing DOCX File" to test downloading an existing DOCX file</li>
                <li>Check that downloaded files have .docx extension and open in Microsoft Word WITHOUT XML errors</li>
                <li>Verify the document structure matches the reference image exactly</li>
            </ol>
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        
        function log(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(message);
        }
        
        async function testPythonDownload() {
            try {
                log("üîÑ Testing Python-generated DOCX download...", 'info');
                
                const testData = {
                    editedText: "Test Subject\n\nRequest for approval regarding test content. This is a test document to verify DOCX download functionality.\n\nThe above proposal is submitted for approval.",
                    subject: "Test DOCX Download",
                    summary: "Testing DOCX download functionality",
                    nfaType: "reimbursement",
                    tableData: [
                        ["slno", "item", "unit", "total"],
                        ["1", "test item", "1", "100"],
                        ["Total", "", "", "100"]
                    ]
                };
                
                const response = await fetch('http://localhost:5000/api/download-edited-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.filePath && result.fileName) {
                        log(`‚úÖ FIXED Python script generated DOCX successfully!\n\nFile: ${result.fileName}\nPath: ${result.filePath}\n\nThis should now:\n‚Ä¢ Download as .docx file (not .txt)\n‚Ä¢ Open in Word WITHOUT XML errors\n‚Ä¢ Match the reference image structure exactly\n‚Ä¢ Include header image and proper formatting\n\nDownloading file...`, 'success');
                        
                        // Test the enhanced download function
                        await downloadFile(result.filePath, result.fileName);
                    } else {
                        log(`‚ö†Ô∏è Python script succeeded but no file generated (fallback mode)\n\nMessage: ${result.message}\n\nThis might indicate the Python script is not working properly.`, 'info');
                    }
                } else {
                    log(`‚ùå Python script failed: ${result.error}\n\nThis indicates there's an issue with the Python script execution.`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error testing Python download: ${error.message}`, 'error');
            }
        }
        
        async function testClientSideDownload() {
            try {
                log("üîÑ Testing client-side DOCX generation...", 'info');
                
                // Simulate the client-side DOCX generation
                const testContent = "Test Subject\n\nRequest for approval regarding client-side test content. This tests the fallback DOCX generation.\n\nThe above proposal is submitted for approval.";
                
                // Create a simple DOCX-like blob for testing
                const testBlob = new Blob(['DOCX_TEST_CONTENT'], { 
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
                });
                
                const url = window.URL.createObjectURL(testBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'test_client_side.docx';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                log("‚úÖ Client-side DOCX download test completed!\n\nFile: test_client_side.docx\n\nCheck your downloads folder.", 'success');
                
            } catch (error) {
                log(`‚ùå Error testing client-side download: ${error.message}`, 'error');
            }
        }
        
        async function testExistingFile() {
            try {
                log("üîÑ Testing existing DOCX file download...", 'info');
                
                // Test downloading an existing DOCX file from the server
                const testFilePath = '/generated_letters/nfa/edited_nfa_20250922_091618.docx';
                const testFileName = 'existing_test_file.docx';
                
                await downloadFile(testFilePath, testFileName);
                
            } catch (error) {
                log(`‚ùå Error testing existing file download: ${error.message}`, 'error');
            }
        }

        async function debugPythonScript() {
            log("üîç Debugging Python script execution...", 'info');
            
            try {
                // Test the Python script directly
                const response = await fetch('http://localhost:5000/api/test-python');
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Python script test successful!\n\nOutput: ${result.output}\n\nThis means Python is working correctly.`, 'success');
                } else {
                    log(`‚ùå Python script test failed!\n\nError: ${result.error}\n\nThis indicates Python is not working properly.`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error testing Python script: ${error.message}`, 'error');
            }
        }
        
        // Enhanced download function (copied from the fixed NFA form)
        async function downloadFile(filePath, fileName = null) {
            try {
                const downloadUrl = `http://localhost:5000${filePath}`;
                console.log("üîó Download URL:", downloadUrl);
                
                // Ensure fileName has .docx extension
                const finalFileName = fileName && fileName.endsWith('.docx') 
                    ? fileName 
                    : `${fileName || 'test_document'}.docx`;
                
                console.log("üìÑ Final filename:", finalFileName);
                
                // Method 1: Try fetch and blob download with proper MIME type
                try {
                    console.log("üîÑ Fetching file from server...");
                    const response = await fetch(downloadUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // Get the blob and ensure it's treated as a DOCX file
                    const blob = await response.blob();
                    console.log("üì¶ Blob received, size:", blob.size, "type:", blob.type);
                    
                    // Create a new blob with the correct MIME type for DOCX
                    const docxBlob = new Blob([blob], { 
                        type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
                    });
                    
                    // Create download URL
                    const url = window.URL.createObjectURL(docxBlob);
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = finalFileName;
                    link.style.display = 'none';
                    
                    // Add to DOM, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up the blob URL
                    window.URL.revokeObjectURL(url);
                    
                    console.log("‚úÖ DOCX file downloaded successfully");
                    log(`‚úÖ DOCX file downloaded successfully!\n\nFile: ${finalFileName}\nSize: ${docxBlob.size} bytes\nMIME Type: ${docxBlob.type}\n\nCheck your downloads folder - the file should have .docx extension and open in Microsoft Word.`, 'success');
                    return;
                } catch (fetchError) {
                    console.warn("‚ö†Ô∏è Fetch download failed, trying direct link method:", fetchError);
                }
                
                // Method 2: Try direct link download as fallback
                try {
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = finalFileName;
                    link.target = '_blank';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log("‚úÖ Direct download initiated");
                    log(`‚úÖ Direct download initiated!\n\nFile: ${finalFileName}\n\nCheck your downloads folder.`, 'success');
                    return;
                } catch (directError) {
                    console.warn("‚ö†Ô∏è Direct download failed:", directError);
                }
                
                throw new Error("All download methods failed");
                
            } catch (error) {
                console.error("‚ùå Download error:", error);
                log(`‚ùå Download failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Auto-run health check on page load
        window.onload = () => {
            setTimeout(() => {
                log("üîÑ Testing server health...", 'info');
                fetch('http://localhost:5000/api/health')
                    .then(response => response.json())
                    .then(result => {
                        log(`‚úÖ Server health check: ${JSON.stringify(result)}`, 'success');
                    })
                    .catch(error => {
                        log(`‚ùå Server health check failed: ${error.message}\n\nMake sure the backend server is running on port 5000.`, 'error');
                    });
            }, 1000);
        };
    </script>
</body>
</html>
