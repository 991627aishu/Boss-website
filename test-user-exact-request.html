<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User's Exact Request</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .content-display { 
            white-space: pre-line; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.4;
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 10px 5px; 
            cursor: pointer; 
            border-radius: 5px;
        }
        button:hover { background: #45a049; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>Test User's Exact Request Pattern</h1>
    <p>This test verifies that the AI chatbox properly handles the exact request pattern from the user's image.</p>
    
    <div>
        <button onclick="testExactUserRequest()">Test Exact User Request</button>
        <button onclick="testSimilarPatterns()">Test Similar Patterns</button>
        <button onclick="testMultipleVariations()">Test Multiple Variations</button>
    </div>
    
    <div id="status"></div>
    
    <div class="test-section">
        <h3>Test Results:</h3>
        <div id="test-results" class="content-display">Click a test button to see the results...</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const testResultsDiv = document.getElementById('test-results');
        
        function log(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(message);
        }
        
        async function generateInitialNFA() {
            const requestData = {
                subject: "Chess By Panchatantra",
                summary: "Chess tournament organized by Panchatantra club on 5th September 2025 at RV University Campus. The event will feature competitive chess matches among students and faculty, promoting strategic thinking and community engagement through chess activities.",
                nfaType: "reimbursement",
                bulletsRequired: true,
                tableData: [
                    ["slno", "item", "unit", "total"],
                    ["1", "prize", "2", "20"],
                    ["2", "prize", "2", "20"],
                    ["3", "prize", "2", "20"],
                    ["Total", "", "", "60"]
                ]
            };
            
            const response = await fetch('http://localhost:5000/api/generate-nfa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            });
            
            const result = await response.json();
            return result;
        }
        
        async function testExactUserRequest() {
            try {
                log("üîÑ Testing the exact user request from the image...", 'info');
                
                // Generate initial NFA
                const initialResult = await generateInitialNFA();
                if (!initialResult.success) {
                    throw new Error("Failed to generate initial NFA");
                }
                
                const originalContent = initialResult.nfaText;
                console.log("üìÑ Original content:", originalContent.substring(0, 200) + "...");
                
                // Test the EXACT request from the user's image
                const exactUserRequest = "Remove Subject: Chess By Panchatantra to Teacher's Day should be earased and it should be Subject: Teacher's Day";
                
                const editRequest = {
                    text: originalContent,
                    prompt: exactUserRequest,
                    subject: "Chess By Panchatantra",
                    summary: "Chess tournament organized by Panchatantra club",
                    nfaType: "reimbursement",
                    bulletsRequired: true,
                    tableData: [["slno", "item", "unit", "total"], ["1", "prize", "2", "20"]]
                };
                
                console.log("üì§ Sending exact user request:", editRequest);
                
                const editResponse = await fetch('http://localhost:5000/api/edit-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(editRequest),
                });
                
                const editResult = await editResponse.json();
                console.log("üì• Exact user request response:", editResult);
                
                if (editResult.success) {
                    const updatedContent = editResult.editedText;
                    
                    // Analyze if the AI understood the exact request
                    const analysis = analyzeExactRequest(originalContent, updatedContent, exactUserRequest);
                    
                    testResultsDiv.textContent = `Original Content:\n${originalContent}\n\n--- UPDATED CONTENT ---\n\n${updatedContent}\n\n--- ANALYSIS ---\n\n${analysis}`;
                    
                    // Check if AI properly extracted "Teacher's Day" as the new subject
                    const hasTeachersDay = updatedContent.toLowerCase().includes("teacher's day");
                    const hasChessPanchatantra = updatedContent.toLowerCase().includes("chess by panchatantra");
                    const subjectLine = updatedContent.match(/Subject:\s*([^\n]+)/i);
                    
                    if (hasTeachersDay && !hasChessPanchatantra && subjectLine && subjectLine[1].toLowerCase().includes("teacher's day")) {
                        log("üéâ PERFECT: AI understood the exact request and changed subject to 'Teacher's Day'", 'success');
                    } else if (hasTeachersDay) {
                        log("‚úÖ GOOD: AI found 'Teacher's Day' but may not have properly replaced the subject line", 'success');
                    } else {
                        log("‚ùå FAILED: AI did not understand the exact request - 'Teacher's Day' not found", 'error');
                    }
                    
                } else {
                    throw new Error(editResult.error || "Exact user request failed");
                }
                
            } catch (error) {
                log(`‚ùå Error testing exact user request: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function testSimilarPatterns() {
            try {
                log("üîÑ Testing similar request patterns...", 'info');
                
                const initialResult = await generateInitialNFA();
                if (!initialResult.success) {
                    throw new Error("Failed to generate initial NFA");
                }
                
                const originalContent = initialResult.nfaText;
                let allResults = `Original Content:\n${originalContent}\n\n`;
                
                // Test similar patterns
                const patterns = [
                    {
                        name: "Pattern 1",
                        request: "Remove Subject: Chess By Panchatantra and it should be Subject: Sports Event",
                        expected: "Sports Event"
                    },
                    {
                        name: "Pattern 2", 
                        request: "Change subject to Workshop on AI",
                        expected: "Workshop on AI"
                    },
                    {
                        name: "Pattern 3",
                        request: "Subject: Music Concert should replace the current subject",
                        expected: "Music Concert"
                    }
                ];
                
                for (const pattern of patterns) {
                    const editRequest = {
                        text: originalContent,
                        prompt: pattern.request,
                        subject: "Chess By Panchatantra",
                        summary: "Chess tournament organized by Panchatantra club",
                        nfaType: "reimbursement",
                        bulletsRequired: true,
                        tableData: [["slno", "item", "unit", "total"], ["1", "prize", "2", "20"]]
                    };
                    
                    const editResponse = await fetch('http://localhost:5000/api/edit-nfa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(editRequest),
                    });
                    
                    const editResult = await editResponse.json();
                    
                    if (editResult.success) {
                        const updatedContent = editResult.editedText;
                        allResults += `After ${pattern.name} (${pattern.request}):\n${updatedContent}\n\n`;
                        
                        // Check if this pattern worked
                        const hasExpectedContent = updatedContent.toLowerCase().includes(pattern.expected.toLowerCase());
                        const subjectLine = updatedContent.match(/Subject:\s*([^\n]+)/i);
                        
                        if (hasExpectedContent && subjectLine && subjectLine[1].toLowerCase().includes(pattern.expected.toLowerCase())) {
                            allResults += `‚úÖ ${pattern.name}: SUCCESS - Subject changed to "${pattern.expected}"\n\n`;
                        } else if (hasExpectedContent) {
                            allResults += `‚ö†Ô∏è ${pattern.name}: PARTIAL - Found "${pattern.expected}" but may not be in subject line\n\n`;
                        } else {
                            allResults += `‚ùå ${pattern.name}: FAILED - "${pattern.expected}" not found\n\n`;
                        }
                    } else {
                        allResults += `‚ùå ${pattern.name}: REQUEST FAILED - ${editResult.error}\n\n`;
                    }
                }
                
                testResultsDiv.textContent = allResults;
                log("‚úÖ Similar patterns tested", 'success');
                
            } catch (error) {
                log(`‚ùå Error testing similar patterns: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function testMultipleVariations() {
            try {
                log("üîÑ Testing multiple variations of the user's request...", 'info');
                
                const initialResult = await generateInitialNFA();
                if (!initialResult.success) {
                    throw new Error("Failed to generate initial NFA");
                }
                
                const originalContent = initialResult.nfaText;
                let allResults = `Original Content:\n${originalContent}\n\n`;
                
                // Test variations of the user's request
                const variations = [
                    "Remove Subject: Chess By Panchatantra to Teacher's Day should be earased and it should be Subject: Teacher's Day",
                    "Subject: Chess By Panchatantra should be earased and it should be Subject: Teacher's Day",
                    "Remove Chess By Panchatantra and it should be Subject: Teacher's Day",
                    "Change subject from Chess By Panchatantra to Teacher's Day",
                    "Subject: Teacher's Day (remove the old subject)",
                    "Replace subject with Teacher's Day"
                ];
                
                let successCount = 0;
                
                for (let i = 0; i < variations.length; i++) {
                    const variation = variations[i];
                    
                    const editRequest = {
                        text: originalContent,
                        prompt: variation,
                        subject: "Chess By Panchatantra",
                        summary: "Chess tournament organized by Panchatantra club",
                        nfaType: "reimbursement",
                        bulletsRequired: true,
                        tableData: [["slno", "item", "unit", "total"], ["1", "prize", "2", "20"]]
                    };
                    
                    const editResponse = await fetch('http://localhost:5000/api/edit-nfa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(editRequest),
                    });
                    
                    const editResult = await editResponse.json();
                    
                    if (editResult.success) {
                        const updatedContent = editResult.editedText;
                        const subjectLine = updatedContent.match(/Subject:\s*([^\n]+)/i);
                        const hasTeachersDay = subjectLine && subjectLine[1].toLowerCase().includes("teacher's day");
                        
                        if (hasTeachersDay) {
                            allResults += `‚úÖ Variation ${i+1}: SUCCESS\n`;
                            successCount++;
                        } else {
                            allResults += `‚ùå Variation ${i+1}: FAILED\n`;
                        }
                        
                        allResults += `Request: "${variation}"\n`;
                        allResults += `Result: "${subjectLine ? subjectLine[1] : 'No subject found'}"\n\n`;
                    } else {
                        allResults += `‚ùå Variation ${i+1}: REQUEST FAILED - ${editResult.error}\n\n`;
                    }
                }
                
                allResults += `=== SUMMARY ===\n`;
                allResults += `Successful variations: ${successCount}/${variations.length}\n`;
                allResults += `Success rate: ${(successCount/variations.length*100).toFixed(1)}%\n`;
                
                testResultsDiv.textContent = allResults;
                
                if (successCount === variations.length) {
                    log(`üéâ PERFECT: All ${variations.length} variations worked successfully!`, 'success');
                } else if (successCount >= variations.length * 0.7) {
                    log(`‚úÖ GOOD: ${successCount}/${variations.length} variations worked (${(successCount/variations.length*100).toFixed(1)}%)`, 'success');
                } else {
                    log(`‚ùå POOR: Only ${successCount}/${variations.length} variations worked (${(successCount/variations.length*100).toFixed(1)}%)`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error testing multiple variations: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        function analyzeExactRequest(original, updated, userRequest) {
            const analysis = [];
            
            analysis.push(`=== Exact Request Analysis ===`);
            analysis.push(`User Request: "${userRequest}"`);
            analysis.push("");
            
            // Check if the AI understood the request
            const expectedSubject = "Teacher's Day";
            const subjectLine = updated.match(/Subject:\s*([^\n]+)/i);
            
            if (subjectLine) {
                const actualSubject = subjectLine[1].trim();
                analysis.push(`Expected Subject: "${expectedSubject}"`);
                analysis.push(`Actual Subject: "${actualSubject}"`);
                
                if (actualSubject.toLowerCase().includes(expectedSubject.toLowerCase())) {
                    analysis.push("‚úÖ SUCCESS: AI correctly understood and applied the request");
                } else {
                    analysis.push("‚ùå FAILED: AI did not understand the request correctly");
                }
            } else {
                analysis.push("‚ùå FAILED: No subject line found in updated content");
            }
            
            // Check for problematic content (the user's instruction text)
            const hasInstructionText = updated.includes("should be earased") || updated.includes("Remove Subject:");
            if (hasInstructionText) {
                analysis.push("‚ö†Ô∏è WARNING: Updated content contains instruction text (not properly cleaned)");
            } else {
                analysis.push("‚úÖ CLEAN: Updated content does not contain instruction text");
            }
            
            return analysis.join('\n');
        }
        
        // Auto-run health check on page load
        window.onload = () => {
            setTimeout(() => {
                log("üîÑ Testing server health...", 'info');
                fetch('http://localhost:5000/api/health')
                    .then(response => response.json())
                    .then(result => {
                        log(`‚úÖ Health check: ${JSON.stringify(result)}`, 'success');
                    })
                    .catch(error => {
                        log(`‚ùå Health check failed: ${error.message}`, 'error');
                    });
            }, 1000);
        };
    </script>
</body>
</html>
