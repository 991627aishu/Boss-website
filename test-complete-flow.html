<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complete NFA Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .content-display { 
            white-space: pre-line; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.4;
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 10px 5px; 
            cursor: pointer; 
            border-radius: 5px;
        }
        button:hover { background: #45a049; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>Test Complete NFA Flow</h1>
    <p>This test verifies the complete flow: Generate NFA ‚Üí Preview ‚Üí Download ‚Üí Verify consistency.</p>
    
    <div>
        <button onclick="testCompleteFlow()">Test Complete Flow</button>
        <button onclick="testWithDifferentInputs()">Test Different Inputs</button>
        <button onclick="verifyConsistency()">Verify Preview = Output</button>
    </div>
    
    <div id="status"></div>
    
    <div class="test-section">
        <h3>Test Results:</h3>
        <div id="test-results" class="content-display">Click a test button to see the results...</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const testResultsDiv = document.getElementById('test-results');
        
        function log(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(message);
        }
        
        async function testCompleteFlow() {
            try {
                log("üîÑ Testing complete NFA flow...", 'info');
                
                const testData = {
                    subject: "inauguration of chess by panchatantra",
                    summary: "inauguration of chess by Panchatantra on 16th August at 10 AM. This event will be held in collaboration with RV University and Bharatiya Vidya Bhavan. The objective is to promote strategic thinking and cultural exchange through chess.",
                    nfaType: "advance",
                    bulletsRequired: true,
                    tableData: [
                        ["slno", "item", "unit", "total"],
                        ["1", "prize", "2", "20"],
                        ["2", "prize", "2", "20"],
                        ["3", "prize", "2", "20"],
                        ["Total", "", "", "60"]
                    ]
                };
                
                let results = "=== COMPLETE NFA FLOW TEST ===\n\n";
                
                // Step 1: Generate NFA
                results += "STEP 1: Generate NFA\n";
                results += "===================\n";
                
                const generateResponse = await fetch('http://localhost:5000/api/generate-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                });
                
                const generateResult = await generateResponse.json();
                
                if (generateResult.success) {
                    results += "‚úÖ NFA Generated Successfully\n";
                    results += `File: ${generateResult.fileName}\n`;
                    results += `Path: ${generateResult.filePath}\n\n`;
                    results += "Generated Content:\n";
                    results += generateResult.nfaText + "\n\n";
                    
                    // Step 2: Download NFA
                    results += "STEP 2: Download NFA\n";
                    results += "===================\n";
                    
                    const downloadData = {
                        editedText: generateResult.nfaText,
                        subject: testData.subject,
                        summary: testData.summary,
                        nfaType: testData.nfaType,
                        tableData: testData.tableData
                    };
                    
                    const downloadResponse = await fetch('http://localhost:5000/api/download-edited-nfa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(downloadData),
                    });
                    
                    const downloadResult = await downloadResponse.json();
                    
                    if (downloadResult.success) {
                        results += "‚úÖ NFA Downloaded Successfully\n";
                        results += `Download File: ${downloadResult.fileName}\n`;
                        results += `Download Path: ${downloadResult.filePath}\n\n`;
                        
                        // Step 3: Verify Consistency
                        results += "STEP 3: Verify Consistency\n";
                        results += "==========================\n";
                        
                        const previewContent = generateResult.nfaText;
                        results += "Preview Content Length: " + previewContent.length + " characters\n";
                        results += "Download File Size: " + (downloadResult.filePath ? "Available" : "Not Available") + "\n\n";
                        
                        // Check if content has proper structure
                        const hasSubject = previewContent.includes("Subject:");
                        const hasRequest = previewContent.includes("Request for approval regarding");
                        const hasBullets = previewContent.includes("‚Ä¢");
                        const hasConclusion = previewContent.includes("The above proposal is submitted for approval");
                        
                        results += "Content Structure Check:\n";
                        results += "- Has Subject: " + (hasSubject ? "‚úÖ" : "‚ùå") + "\n";
                        results += "- Has Request Paragraph: " + (hasRequest ? "‚úÖ" : "‚ùå") + "\n";
                        results += "- Has Bullet Points: " + (hasBullets ? "‚úÖ" : "‚ùå") + "\n";
                        results += "- Has Conclusion: " + (hasConclusion ? "‚úÖ" : "‚ùå") + "\n\n";
                        
                        if (hasSubject && hasRequest && hasBullets && hasConclusion) {
                            results += "üéâ COMPLETE FLOW SUCCESSFUL!\n";
                            results += "All components working correctly.\n";
                            log("‚úÖ Complete flow test successful!", 'success');
                        } else {
                            results += "‚ö†Ô∏è Some components missing or incorrect.\n";
                            log("‚ö†Ô∏è Complete flow test has issues", 'warning');
                        }
                        
                        // Provide download link
                        const downloadUrl = `http://localhost:5000${downloadResult.filePath}`;
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = downloadResult.fileName;
                        link.textContent = `Download: ${downloadResult.fileName}`;
                        link.style.display = 'block';
                        link.style.marginTop = '10px';
                        link.style.color = '#4caf50';
                        link.style.textDecoration = 'underline';
                        testResultsDiv.appendChild(link);
                        
                    } else {
                        results += "‚ùå Download Failed: " + downloadResult.error + "\n";
                        log("‚ùå Download failed", 'error');
                    }
                    
                } else {
                    results += "‚ùå Generation Failed: " + generateResult.error + "\n";
                    log("‚ùå Generation failed", 'error');
                }
                
                testResultsDiv.textContent = results;
                
            } catch (error) {
                log(`‚ùå Error in complete flow test: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function testWithDifferentInputs() {
            try {
                log("üîÑ Testing with different user inputs...", 'info');
                
                const testCases = [
                    {
                        name: "Chess Inauguration (With Bullets + Table)",
                        data: {
                            subject: "inauguration of chess by panchatantra",
                            summary: "inauguration of chess by Panchatantra on 16th August at 10 AM. This event will be held in collaboration with RV University and Bharatiya Vidya Bhavan.",
                            nfaType: "advance",
                            bulletsRequired: true,
                            tableData: [["slno", "item", "unit", "total"], ["1", "prize", "2", "20"], ["2", "prize", "2", "20"], ["Total", "", "", "40"]]
                        }
                    },
                    {
                        name: "Teacher's Day (With Bullets + No Table)",
                        data: {
                            subject: "Teacher's Day Celebration",
                            summary: "Teacher's Day Celebration on 5th September 2025 to honor and appreciate our dedicated teaching staff with cultural performances, recognition awards, and special luncheon for 150 participants.",
                            nfaType: "advance",
                            bulletsRequired: true,
                            tableData: []
                        }
                    },
                    {
                        name: "Sports Tournament (No Bullets + Table)",
                        data: {
                            subject: "Inter-College Sports Tournament",
                            summary: "Inter-college sports tournament on 15th October 2025 featuring cricket, football, and basketball competitions with 20 participating colleges and prize distribution ceremony.",
                            nfaType: "reimbursement",
                            bulletsRequired: false,
                            tableData: [["slno", "item", "unit", "total"], ["1", "trophy", "1", "5000"], ["2", "medals", "20", "2000"], ["Total", "", "", "7000"]]
                        }
                    },
                    {
                        name: "Workshop (No Bullets + No Table)",
                        data: {
                            subject: "Technical Workshop on AI",
                            summary: "Technical workshop on Artificial Intelligence and Machine Learning on 20th November 2025 for 100 students with expert speakers and hands-on training sessions.",
                            nfaType: "advance",
                            bulletsRequired: false,
                            tableData: []
                        }
                    }
                ];
                
                let results = "=== DIFFERENT INPUTS TEST ===\n\n";
                
                for (const testCase of testCases) {
                    results += `Test Case: ${testCase.name}\n`;
                    results += "=" + "=".repeat(testCase.name.length) + "\n\n";
                    
                    try {
                        const response = await fetch('http://localhost:5000/api/generate-nfa', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(testCase.data),
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            results += "‚úÖ Generated Successfully\n";
                            results += `File: ${result.fileName}\n\n`;
                            
                            // Analyze content structure
                            const content = result.nfaText;
                            const hasSubject = content.includes("Subject:");
                            const hasRequest = content.includes("Request for approval regarding");
                            const hasBullets = content.includes("‚Ä¢");
                            const hasTable = content.includes("slno") || content.includes("item");
                            
                            results += "Structure Analysis:\n";
                            results += `- Subject: ${hasSubject ? "‚úÖ" : "‚ùå"}\n`;
                            results += `- Request Paragraph: ${hasRequest ? "‚úÖ" : "‚ùå"}\n`;
                            results += `- Bullet Points: ${hasBullets ? "‚úÖ" : "‚ùå"} (Expected: ${testCase.data.bulletsRequired ? "Yes" : "No"})\n`;
                            results += `- Table Data: ${hasTable ? "‚úÖ" : "‚ùå"} (Expected: ${testCase.data.tableData.length > 0 ? "Yes" : "No"})\n\n`;
                            
                            // Check if structure matches expectations
                            const bulletsMatch = hasBullets === testCase.data.bulletsRequired;
                            const tableMatch = hasTable === (testCase.data.tableData.length > 0);
                            
                            if (bulletsMatch && tableMatch) {
                                results += "üéâ Structure matches expectations!\n\n";
                            } else {
                                results += "‚ö†Ô∏è Structure doesn't match expectations.\n\n";
                            }
                            
                        } else {
                            results += `‚ùå Failed: ${result.error}\n\n`;
                        }
                        
                    } catch (error) {
                        results += `‚ùå Error: ${error.message}\n\n`;
                    }
                }
                
                testResultsDiv.textContent = results;
                log("‚úÖ Different inputs test completed", 'success');
                
            } catch (error) {
                log(`‚ùå Error in different inputs test: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function verifyConsistency() {
            try {
                log("üîÑ Verifying preview and output consistency...", 'info');
                
                const testData = {
                    subject: "Consistency Test Event",
                    summary: "Testing event to verify that preview content matches the downloaded output exactly.",
                    nfaType: "advance",
                    bulletsRequired: true,
                    tableData: [["slno", "item", "unit", "total"], ["1", "test", "1", "100"]]
                };
                
                let results = "=== CONSISTENCY VERIFICATION ===\n\n";
                
                // Generate NFA
                const generateResponse = await fetch('http://localhost:5000/api/generate-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                });
                
                const generateResult = await generateResponse.json();
                
                if (generateResult.success) {
                    results += "‚úÖ NFA Generated\n";
                    results += `Preview Content Length: ${generateResult.nfaText.length} characters\n\n`;
                    
                    // Download NFA
                    const downloadData = {
                        editedText: generateResult.nfaText,
                        subject: testData.subject,
                        summary: testData.summary,
                        nfaType: testData.nfaType,
                        tableData: testData.tableData
                    };
                    
                    const downloadResponse = await fetch('http://localhost:5000/api/download-edited-nfa', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(downloadData),
                    });
                    
                    const downloadResult = await downloadResponse.json();
                    
                    if (downloadResult.success) {
                        results += "‚úÖ NFA Downloaded\n";
                        results += `Download File: ${downloadResult.fileName}\n\n`;
                        
                        // Verify consistency
                        results += "Consistency Check:\n";
                        results += "==================\n";
                        
                        const previewContent = generateResult.nfaText;
                        const hasAllComponents = previewContent.includes("Subject:") && 
                                               previewContent.includes("Request for approval regarding") &&
                                               previewContent.includes("‚Ä¢") &&
                                               previewContent.includes("The above proposal is submitted for approval");
                        
                        if (hasAllComponents) {
                            results += "‚úÖ Preview contains all required components\n";
                            results += "‚úÖ Download file created successfully\n";
                            results += "‚úÖ Content structure is consistent\n\n";
                            results += "üéâ CONSISTENCY VERIFIED!\n";
                            results += "Preview and output are consistent.\n";
                            log("‚úÖ Consistency verified!", 'success');
                        } else {
                            results += "‚ùå Preview missing some components\n";
                            results += "‚ùå Consistency issues detected\n";
                            log("‚ùå Consistency issues detected", 'error');
                        }
                        
                        // Provide download link
                        const downloadUrl = `http://localhost:5000${downloadResult.filePath}`;
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = downloadResult.fileName;
                        link.textContent = `Download: ${downloadResult.fileName}`;
                        link.style.display = 'block';
                        link.style.marginTop = '10px';
                        link.style.color = '#4caf50';
                        link.style.textDecoration = 'underline';
                        testResultsDiv.appendChild(link);
                        
                    } else {
                        results += `‚ùå Download Failed: ${downloadResult.error}\n`;
                        log("‚ùå Download failed", 'error');
                    }
                    
                } else {
                    results += `‚ùå Generation Failed: ${generateResult.error}\n`;
                    log("‚ùå Generation failed", 'error');
                }
                
                testResultsDiv.textContent = results;
                
            } catch (error) {
                log(`‚ùå Error in consistency verification: ${error.message}`, 'error');
                testResultsDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        // Auto-run health check on page load
        window.onload = () => {
            setTimeout(() => {
                log("üîÑ Testing server health...", 'info');
                fetch('http://localhost:5000/api/health')
                    .then(response => response.json())
                    .then(result => {
                        log(`‚úÖ Health check: ${JSON.stringify(result)}`, 'success');
                    })
                    .catch(error => {
                        log(`‚ùå Health check failed: ${error.message}`, 'error');
                    });
            }, 1000);
        };
    </script>
</body>
</html>
