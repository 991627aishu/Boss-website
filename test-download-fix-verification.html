<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFA Download Fix Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #1976d2;
            margin-top: 0;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        .warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß NFA Download Fix Verification</h1>
        <p>This test verifies that all the fixes for the NFA download to DOCX functionality are working correctly.</p>

        <div class="test-section">
            <h3>1. Check Python Dependencies</h3>
            <button onclick="checkPythonDependencies()">Check Python Dependencies</button>
            <div id="dependencies-result"></div>
        </div>

        <div class="test-section">
            <h3>2. Test Python Script Directly</h3>
            <button onclick="testPythonScript()">Test Python Script</button>
            <div id="python-script-result"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Download Mode</h3>
            <button onclick="testDownloadMode()">Test Download Mode</button>
            <div id="download-mode-result"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Complete Download Flow</h3>
            <button onclick="testCompleteDownloadFlow()">Test Complete Download Flow</button>
            <div id="complete-flow-result"></div>
        </div>

        <div class="test-section">
            <h3>5. Test with Bullet Points</h3>
            <button onclick="testWithBulletPoints()">Test with Bullet Points</button>
            <div id="bullet-points-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test Results Summary</h3>
            <div id="summary-result">
                <p>Run the tests above to see results...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';

        async function checkPythonDependencies() {
            const resultDiv = document.getElementById('dependencies-result');
            resultDiv.innerHTML = 'Checking Python dependencies...';
            
            try {
                const response = await fetch(`${API_BASE}/api/test-python`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="result success">‚úÖ Python is working correctly\n\nCommand: ${data.command}\nOutput: ${data.output}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Python test failed\n\nError: ${data.error}\nDetails: ${data.details}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Failed to check Python dependencies\n\nError: ${error.message}</div>`;
            }
        }

        async function testPythonScript() {
            const resultDiv = document.getElementById('python-script-result');
            resultDiv.innerHTML = 'Testing Python script...';
            
            try {
                // Test the Python script directly using the test script
                const response = await fetch(`${API_BASE}/api/test-python`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="result success">‚úÖ Python script is working\n\nCommand: ${data.command}\nOutput: ${data.output}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Python script test failed\n\nError: ${data.error}\nDetails: ${data.details}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Python script test failed\n\nError: ${error.message}</div>`;
            }
        }

        async function testDownloadMode() {
            const resultDiv = document.getElementById('download-mode-result');
            resultDiv.innerHTML = 'Testing download mode...';
            
            const testData = {
                editedText: `Subject: Test NFA Document

Request for approval regarding test document generation. This is a test to verify the download functionality works correctly.

‚Ä¢ The test will verify document generation
‚Ä¢ Proper formatting and structure will be maintained
‚Ä¢ Download functionality will be tested thoroughly

The above proposal is submitted for approval, and the amount may kindly be reimbursed to the organizing committee after the event upon submission of the online report, receipts, and GST bills.`,
                subject: "Test NFA Document",
                summary: "Test document for download verification",
                nfaType: "reimbursement",
                tableData: [
                    ["Item", "Quantity", "Unit Cost", "Total Cost"],
                    ["Test Item 1", "5", "‚Çπ100", "‚Çπ500"],
                    ["Test Item 2", "3", "‚Çπ200", "‚Çπ600"]
                ]
            };
            
            try {
                console.log('üì§ Testing download mode...');
                
                const response = await fetch(`${API_BASE}/api/download-edited-nfa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                console.log('üì• Download mode response:', data);
                
                if (data.success) {
                    if (data.filePath && data.fileName) {
                        resultDiv.innerHTML = `<div class="result success">‚úÖ Download mode working!\n\nFile Path: ${data.filePath}\nFile Name: ${data.fileName}\nMessage: ${data.message}</div>`;
                        
                        // Test the actual file download
                        await testFileDownload(data.filePath, data.fileName, resultDiv);
                    } else {
                        resultDiv.innerHTML = `<div class="result warning">‚ö†Ô∏è Download mode responded but no file generated\n\nResponse: ${JSON.stringify(data, null, 2)}\n\nThis might be fallback mode - Python/DOCX generation unavailable</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Download mode failed\n\nError: ${data.error}\nResponse: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Download mode test failed\n\nError: ${error.message}</div>`;
                console.error('Download mode test error:', error);
            }
        }

        async function testCompleteDownloadFlow() {
            const resultDiv = document.getElementById('complete-flow-result');
            resultDiv.innerHTML = 'Testing complete download flow...';
            
            try {
                // First generate an NFA
                const generateData = {
                    subject: "Complete Test NFA",
                    summary: "Complete test for download verification",
                    bulletsRequired: true,
                    nfaType: "reimbursement",
                    tableData: [
                        ["Item", "Quantity", "Unit Cost", "Total Cost"],
                        ["Test Item 1", "5", "‚Çπ100", "‚Çπ500"],
                        ["Test Item 2", "3", "‚Çπ200", "‚Çπ600"]
                    ]
                };
                
                console.log('üì§ Generating NFA first...');
                
                const generateResponse = await fetch(`${API_BASE}/api/generate-nfa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(generateData)
                });
                
                const generateData_result = await generateResponse.json();
                console.log('üì• Generate response:', generateData_result);
                
                if (generateData_result.success && generateData_result.nfaText) {
                    // Now test download with the generated content
                    const downloadData = {
                        editedText: generateData_result.nfaText,
                        subject: "Complete Test NFA",
                        summary: "Complete test for download verification",
                        nfaType: "reimbursement",
                        tableData: generateData.tableData
                    };
                    
                    console.log('üì§ Now testing download with generated content...');
                    
                    const downloadResponse = await fetch(`${API_BASE}/api/download-edited-nfa`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(downloadData)
                    });
                    
                    const downloadResult = await downloadResponse.json();
                    console.log('üì• Download response:', downloadResult);
                    
                    if (downloadResult.success && downloadResult.filePath && downloadResult.fileName) {
                        resultDiv.innerHTML = `<div class="result success">‚úÖ Complete download flow working!\n\nGenerated File: ${downloadResult.fileName}\nFile Path: ${downloadResult.filePath}\nMessage: ${downloadResult.message}</div>`;
                        
                        // Test the actual file download
                        await testFileDownload(downloadResult.filePath, downloadResult.fileName, resultDiv);
                    } else {
                        resultDiv.innerHTML = `<div class="result error">‚ùå Complete download flow failed\n\nResponse: ${JSON.stringify(downloadResult, null, 2)}</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå NFA generation failed\n\nResponse: ${JSON.stringify(generateData_result, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Complete download flow test failed\n\nError: ${error.message}</div>`;
                console.error('Complete download flow test error:', error);
            }
        }

        async function testWithBulletPoints() {
            const resultDiv = document.getElementById('bullet-points-result');
            resultDiv.innerHTML = 'Testing download with bullet points...';
            
            const testData = {
                editedText: `Subject: Chess Tournament

Request for approval regarding chess tournament on 5th September. This tournament will promote strategic thinking and cultural exchange.

‚Ä¢ The tournament will feature competitive matches with proper organization
‚Ä¢ Awards and recognition will be provided to participants
‚Ä¢ Proper administrative procedures will be followed for event coordination

The above proposal is submitted for approval, and the amount may kindly be reimbursed to the organizing committee after the event upon submission of the online report, receipts, and GST bills.`,
                subject: "Chess Tournament",
                summary: "Chess tournament on 5th September",
                nfaType: "reimbursement",
                tableData: []
            };
            
            try {
                console.log('üì§ Testing download with bullet points...');
                
                const response = await fetch(`${API_BASE}/api/download-edited-nfa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                console.log('üì• Bullet points download response:', data);
                
                if (data.success && data.filePath && data.fileName) {
                    resultDiv.innerHTML = `<div class="result success">‚úÖ Download with bullet points working!\n\nFile Path: ${data.filePath}\nFile Name: ${data.fileName}\nMessage: ${data.message}</div>`;
                    
                    // Test the actual file download
                    await testFileDownload(data.filePath, data.fileName, resultDiv);
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Download with bullet points failed\n\nResponse: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Bullet points test failed\n\nError: ${error.message}</div>`;
                console.error('Bullet points test error:', error);
            }
        }

        async function testFileDownload(filePath, fileName, resultDiv) {
            const downloadUrl = `${API_BASE}${filePath}`;
            console.log('üîó Testing file download from:', downloadUrl);
            
            try {
                // Test if file exists
                const headResponse = await fetch(downloadUrl, { method: 'HEAD' });
                
                if (!headResponse.ok) {
                    throw new Error(`File not found: ${headResponse.status} ${headResponse.statusText}`);
                }
                
                resultDiv.innerHTML += `\n\n‚úÖ File exists on server (${headResponse.status})\n`;
                
                // Try download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName || `test-download-${Date.now()}.docx`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                resultDiv.innerHTML += `‚úÖ Download initiated successfully!\n`;
                
            } catch (error) {
                resultDiv.innerHTML += `\n\n‚ùå File download failed: ${error.message}\n`;
                console.error('File download error:', error);
            }
        }

        // Auto-run basic test on page load
        window.onload = function() {
            console.log('üîß NFA Download Fix Verification Page Loaded');
            console.log('Click the buttons above to test the download functionality');
        };
    </script>
</body>
</html>
