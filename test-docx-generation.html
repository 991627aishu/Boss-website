<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side DOCX Generation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <h1>üß™ Client-Side DOCX Generation Test</h1>
    
    <div class="test-section">
        <h2>Test Content</h2>
        <textarea id="testContent" placeholder="Enter NFA content to test...">
Subject: inauguration of chess by panchatantra

Request for approval regarding the inauguration of chess by Panchatantra on 16th August at 10 AM. This event will be held in collaboration with RV University and Bharatiya Vidya Bhavan. The objective is to promote strategic thinking and cultural exchange through chess.

‚Ä¢ The inauguration will feature AVS Murthy, Chancellor of RV University, as the chief guest.
‚Ä¢ The event aims to foster educational partnerships between institutions and enhance community engagement.
        </textarea>
        
        <button onclick="testDocxGeneration()">Generate DOCX Document</button>
        <div id="result"></div>
    </div>

    <script>
        async function testDocxGeneration() {
            const resultDiv = document.getElementById('result');
            const content = document.getElementById('testContent').value;
            
            if (!content.trim()) {
                resultDiv.innerHTML = '<div class="result error">‚ùå Please enter some content to test</div>';
                return;
            }
            
            try {
                resultDiv.innerHTML = 'Generating DOCX document...';
                
                // Clean content
                const cleanContent = content.replace(/[^\x20-\x7E\u00A0-\uFFFF]/g, '').trim();
                
                // Create the document using docx library with robust structure
                const doc = new docx.Document({
                    sections: [{
                        properties: {
                            page: {
                                size: {
                                    orientation: "portrait",
                                    width: 595,
                                    height: 842,
                                },
                                margin: {
                                    top: 720,
                                    right: 720,
                                    bottom: 720,
                                    left: 720,
                                },
                            },
                        },
                        children: [
                            // Title
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "NFA Output",
                                        bold: true,
                                        size: 32,
                                        font: "Arial",
                                    }),
                                ],
                                alignment: docx.AlignmentType.CENTER,
                                spacing: {
                                    after: 400,
                                },
                            }),
                            
                            // Date
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: `Date: ${new Date().toLocaleDateString('en-GB')}`,
                                        size: 24,
                                        font: "Arial",
                                    }),
                                ],
                                alignment: docx.AlignmentType.RIGHT,
                                spacing: {
                                    after: 400,
                                },
                            }),
                            
                            // Content
                            ...formatContentForDocx(cleanContent),
                            
                            // Conclusion
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: "The above proposal is submitted for approval, and the amount may kindly be reimbursed to the organizing committee after the event upon submission of the online report, receipts, and GST bills.",
                                        size: 24,
                                        font: "Arial",
                                    }),
                                ],
                                alignment: docx.AlignmentType.JUSTIFY,
                                spacing: {
                                    before: 400,
                                    after: 400,
                                },
                            }),
                            
                            // Signatures
                            ...generateSignatureSection(),
                        ],
                    }],
                });
                
                // Generate and download the document
                const blob = await docx.Packer.toBlob(doc);
                const fileName = `test_nfa_output_${new Date().toISOString().slice(0, 10)}.docx`;
                
                saveAs(blob, fileName);
                
                resultDiv.innerHTML = '<div class="result success">‚úÖ DOCX document generated and downloaded successfully!</div>';
                
            } catch (error) {
                console.error('Error generating DOCX:', error);
                resultDiv.innerHTML = `<div class="result error">‚ùå Error generating DOCX: ${error.message}</div>`;
            }
        }

        // Format content for DOCX
        function formatContentForDocx(content) {
            if (!content) return [];
            
            const paragraphs = [];
            const lines = content.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line) {
                    // Empty line
                    paragraphs.push(new docx.Paragraph({
                        children: [new docx.TextRun({ text: " ", size: 24, font: "Arial" })],
                        spacing: { after: 200 },
                    }));
                    continue;
                }
                
                // Clean the line
                const cleanLine = line.replace(/[^\x20-\x7E\u00A0-\uFFFF]/g, '').trim();
                if (!cleanLine) continue;
                
                // Subject line
                if (cleanLine.toLowerCase().startsWith('subject:')) {
                    const subjectText = cleanLine.substring(8).trim();
                    paragraphs.push(new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: "Subject: ",
                                bold: true,
                                size: 24,
                                font: "Arial",
                            }),
                            new docx.TextRun({
                                text: subjectText,
                                size: 24,
                                font: "Arial",
                            }),
                        ],
                        alignment: docx.AlignmentType.JUSTIFY,
                        spacing: { after: 200 },
                    }));
                    continue;
                }
                
                // Bullet points
                if (cleanLine.startsWith('‚Ä¢')) {
                    const bulletText = cleanLine.substring(1).trim();
                    paragraphs.push(new docx.Paragraph({
                        children: [
                            new docx.TextRun({
                                text: "‚Ä¢ ",
                                size: 24,
                                font: "Arial",
                            }),
                            new docx.TextRun({
                                text: bulletText,
                                size: 24,
                                font: "Arial",
                            }),
                        ],
                        alignment: docx.AlignmentType.JUSTIFY,
                        spacing: { after: 200 },
                    }));
                    continue;
                }
                
                // Regular paragraphs
                paragraphs.push(new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: cleanLine,
                            size: 24,
                            font: "Arial",
                        }),
                    ],
                    alignment: docx.AlignmentType.JUSTIFY,
                    spacing: { after: 200 },
                }));
            }
            
            return paragraphs;
        }

        // Generate signature section
        function generateSignatureSection() {
            const signatures = [
                { name: "Dr Phani Kumar Pullela", designation: "Dean, Student Affairs", label: "(Prepared by)" },
                { name: "Mr Chandrasekhar KN", designation: "Head Finance", label: "(Approved by)" },
                { name: "Dr Sahana D Gowda", designation: "Registrar - RV University", label: "(Recommended by)" },
                { name: "Prof (Dr) Dwarika Prasad Uniyal", designation: "Vice Chancellor (i/c)", label: "(Approved by)" }
            ];
            
            const signatureElements = [];
            
            signatures.forEach((sig) => {
                // Signature line
                signatureElements.push(new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: "_________________",
                            size: 20,
                            font: "Arial",
                        }),
                    ],
                    alignment: docx.AlignmentType.JUSTIFY,
                    spacing: { after: 100 },
                }));
                
                // Name
                signatureElements.push(new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: sig.name,
                            size: 20,
                            font: "Arial",
                        }),
                    ],
                    alignment: docx.AlignmentType.JUSTIFY,
                    spacing: { after: 100 },
                }));
                
                // Designation
                signatureElements.push(new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: sig.designation,
                            size: 20,
                            font: "Arial",
                        }),
                    ],
                    alignment: docx.AlignmentType.JUSTIFY,
                    spacing: { after: 100 },
                }));
                
                // Label
                signatureElements.push(new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: sig.label,
                            size: 20,
                            font: "Arial",
                        }),
                    ],
                    alignment: docx.AlignmentType.JUSTIFY,
                    spacing: { after: 200 },
                }));
            });
            
            return signatureElements;
        }

        // Auto-test on page load
        window.onload = function() {
            console.log('üß™ Client-Side DOCX Generation Test Page Loaded');
            console.log('Enter content and click "Generate DOCX Document" to test');
        };
    </script>
</body>
</html>
