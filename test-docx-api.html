<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DOCX Download API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #1565c0;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test DOCX Download API</h1>
        <p>This test verifies that the download API is working correctly and generating DOCX files.</p>

        <button onclick="testDownloadAPI()">Test Download API</button>
        <button onclick="testWithRealData()">Test with Real NFA Data</button>
        
        <div id="result"></div>
    </div>

    <script>
        async function testDownloadAPI() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing download API...';
            
            const testData = {
                editedText: `Subject: Test NFA Document

Request for approval regarding test document generation. This is a test to verify the download functionality works correctly.

‚Ä¢ The test will verify document generation
‚Ä¢ Proper formatting and structure will be maintained
‚Ä¢ Download functionality will be tested thoroughly

The above proposal is submitted for approval, and the amount may kindly be reimbursed to the organizing committee after the event upon submission of the online report, receipts, and GST bills.`,
                subject: "Test NFA Document",
                summary: "Test document for download verification",
                nfaType: "reimbursement",
                tableData: [
                    ["Item", "Quantity", "Unit Cost", "Total Cost"],
                    ["Test Item 1", "5", "‚Çπ100", "‚Çπ500"],
                    ["Test Item 2", "3", "‚Çπ200", "‚Çπ600"]
                ]
            };
            
            try {
                console.log('üì§ Testing download API...');
                
                const response = await fetch('http://localhost:5000/api/download-edited-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                console.log('üì• Download API response:', data);
                
                if (data.success) {
                    if (data.filePath && data.fileName) {
                        resultDiv.innerHTML = `<div class="result success">‚úÖ Download API working!\n\nFile Path: ${data.filePath}\nFile Name: ${data.fileName}\nMessage: ${data.message}\n\nTesting file download...</div>`;
                        
                        // Test the actual file download
                        await testFileDownload(data.filePath, data.fileName, resultDiv);
                    } else {
                        resultDiv.innerHTML = `<div class="result error">‚ùå Download API responded but no file generated\n\nResponse: ${JSON.stringify(data, null, 2)}\n\nThis indicates fallback mode - Python/DOCX generation unavailable</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Download API failed\n\nError: ${data.error}\nResponse: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Download API test failed\n\nError: ${error.message}</div>`;
                console.error('Download API test error:', error);
            }
        }

        async function testWithRealData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing with real NFA data...';
            
            const realData = {
                editedText: `Subject: Chess Tournament

Request for approval regarding chess tournament on 5th September. This tournament will promote strategic thinking and cultural exchange.

‚Ä¢ The tournament will feature competitive matches with proper organization
‚Ä¢ Awards and recognition will be provided to participants
‚Ä¢ Proper administrative procedures will be followed for event coordination

The above proposal is submitted for approval, and the amount may kindly be reimbursed to the organizing committee after the event upon submission of the online report, receipts, and GST bills.`,
                subject: "Chess Tournament",
                summary: "Chess tournament on 5th September",
                nfaType: "reimbursement",
                tableData: [
                    ["slno", "item", "unit", "total"],
                    ["1", "prize", "2", "20"],
                    ["1", "prize", "2", "20"],
                    ["1", "prize", "2", "20"]
                ]
            };
            
            try {
                console.log('üì§ Testing with real NFA data...');
                
                const response = await fetch('http://localhost:5000/api/download-edited-nfa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(realData)
                });
                
                const data = await response.json();
                console.log('üì• Real data response:', data);
                
                if (data.success) {
                    if (data.filePath && data.fileName) {
                        resultDiv.innerHTML = `<div class="result success">‚úÖ Real NFA data test successful!\n\nFile Path: ${data.filePath}\nFile Name: ${data.fileName}\nMessage: ${data.message}\n\nTesting file download...</div>`;
                        
                        // Test the actual file download
                        await testFileDownload(data.filePath, data.fileName, resultDiv);
                    } else {
                        resultDiv.innerHTML = `<div class="result error">‚ùå Real NFA data test failed - no file generated\n\nResponse: ${JSON.stringify(data, null, 2)}</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Real NFA data test failed\n\nError: ${data.error}\nResponse: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Real NFA data test failed\n\nError: ${error.message}</div>`;
                console.error('Real NFA data test error:', error);
            }
        }

        async function testFileDownload(filePath, fileName, resultDiv) {
            const downloadUrl = `http://localhost:5000${filePath}`;
            console.log('üîó Testing file download from:', downloadUrl);
            
            try {
                // Test if file exists
                const headResponse = await fetch(downloadUrl, { method: 'HEAD' });
                
                if (!headResponse.ok) {
                    throw new Error(`File not found: ${headResponse.status} ${headResponse.statusText}`);
                }
                
                resultDiv.innerHTML += `\n\n‚úÖ File exists on server (${headResponse.status})\n`;
                
                // Check content type
                const contentType = headResponse.headers.get('content-type');
                resultDiv.innerHTML += `üìÑ Content Type: ${contentType}\n`;
                
                if (contentType && contentType.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
                    resultDiv.innerHTML += `‚úÖ Correct DOCX content type detected!\n`;
                } else {
                    resultDiv.innerHTML += `‚ö†Ô∏è Unexpected content type - might not be DOCX\n`;
                }
                
                // Try download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName || `test-download-${Date.now()}.docx`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                resultDiv.innerHTML += `‚úÖ Download initiated successfully!\n`;
                
            } catch (error) {
                resultDiv.innerHTML += `\n\n‚ùå File download failed: ${error.message}\n`;
                console.error('File download error:', error);
            }
        }

        // Auto-run test on page load
        window.onload = function() {
            console.log('üß™ DOCX Download API Test Page Loaded');
            console.log('Click the buttons above to test the download functionality');
        };
    </script>
</body>
</html>
