<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side DOCX Generation Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #1565c0;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Client-Side DOCX Generation Fix</h1>
        <p>This tool generates XML-safe DOCX files that will open correctly in Microsoft Word.</p>

        <div class="form-group">
            <label for="subject">Subject:</label>
            <input type="text" id="subject" value="Chess By Panchatantra" placeholder="Enter subject">
        </div>

        <div class="form-group">
            <label for="summary">Summary:</label>
            <textarea id="summary" placeholder="Enter summary">RVU clubs combined celebrate the event Chess By Panchatantra in the RV University Campus. This proposal requires administrative approval for successful execution.</textarea>
        </div>

        <div class="form-group">
            <label for="nfaType">NFA Type:</label>
            <select id="nfaType">
                <option value="reimbursement">Reimbursement</option>
                <option value="advance">Advance</option>
            </select>
        </div>

        <div class="form-group">
            <label for="needBullets">Include Bullet Points:</label>
            <select id="needBullets">
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </div>

        <button onclick="generateNFADocx()">Generate NFA DOCX</button>
        <button onclick="testWithSampleData()">Test with Sample Data</button>
        
        <div id="result"></div>
    </div>

    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        const { Document, Packer, Paragraph, TextRun, AlignmentType, DocxTable, DocxTableRow, DocxTableCell, BorderStyle, WidthType } = docx;

        function cleanTextForXML(text) {
            if (!text) return "";
            
            return text
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Remove control characters
                .replace(/[^\x20-\x7E\u00A0-\uFFFF]/g, '') // Keep only printable characters
                .replace(/\s+/g, ' ') // Normalize whitespace
                .trim();
        }

        function generateNFADocx() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Generating NFA DOCX...';
            
            try {
                const subject = cleanTextForXML(document.getElementById('subject').value);
                const summary = cleanTextForXML(document.getElementById('summary').value);
                const nfaType = document.getElementById('nfaType').value;
                const needBullets = document.getElementById('needBullets').value === 'yes';
                
                console.log('üìù Generating NFA DOCX with:', { subject, summary, nfaType, needBullets });
                
                // Generate content based on inputs
                let content = `${subject}\n\nRequest for approval regarding ${summary}. This proposal requires administrative approval for successful execution.`;
                
                if (needBullets) {
                    content += `\n\n‚Ä¢ The event will promote community engagement and collaboration among participants\n‚Ä¢ Proper administrative procedures will be followed for event coordination\n‚Ä¢ All necessary approvals and permissions will be obtained before the event`;
                }
                
                if (nfaType === 'advance') {
                    content += `\n\nThe above proposal is submitted for approval, and the advance amount may kindly be released to the organizing committee to conduct the event smoothly.`;
                } else {
                    content += `\n\nThe above proposal is submitted for approval, and the amount may kindly be reimbursed to the organizing committee after the event upon submission of the online report, receipts, and GST bills.`;
                }
                
                // Clean content for XML safety
                const cleanContent = cleanTextForXML(content);
                console.log('üßπ Content cleaned, length:', cleanContent.length);

                // Create document with proper structure
                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                size: {
                                    orientation: "portrait",
                                    width: 595,
                                    height: 842,
                                },
                                margin: {
                                    top: 720,
                                    right: 720,
                                    bottom: 720,
                                    left: 720,
                                },
                            },
                        },
                        children: [
                            // Date - Right aligned
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Date: ${new Date().toLocaleDateString('en-GB').replace(/[^\x20-\x7E]/g, '')}`,
                                        size: 20,
                                        font: "Arial",
                                    }),
                                ],
                                alignment: AlignmentType.RIGHT,
                                spacing: { after: 300 },
                            }),
                            
                            // NFA Title - Centered
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Note For Approval (NFA)",
                                        bold: true,
                                        size: 22,
                                        font: "Arial",
                                    }),
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 300 },
                            }),
                            
                            // Content paragraphs
                            ...createTemplateParagraphs(cleanContent),
                            
                            // Simple signature section
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Dr Phani Kumar Pullela".replace(/[^\x20-\x7E]/g, ''),
                                        size: 20,
                                        font: "Arial",
                                    }),
                                ],
                                alignment: AlignmentType.JUSTIFY,
                                spacing: { after: 200 },
                            }),
                        ],
                    }],
                });

                console.log('üìù Document structure created successfully');

                // Generate and download the document
                console.log('üîÑ Converting document to blob...');
                const blob = await Packer.toBlob(doc);
                console.log('üì¶ Blob created, size:', blob.size);

                const fileName = `nfa_output_${new Date().toISOString().slice(0, 10)}.docx`;
                console.log('üíæ Downloading file:', fileName);

                saveAs(blob, fileName);

                resultDiv.innerHTML = `<div class="result success">‚úÖ NFA DOCX generated successfully!\n\nFile: ${fileName}\nSize: ${blob.size} bytes\n\nThis DOCX file should now open correctly in Microsoft Word without XML errors.</div>`;
                
            } catch (error) {
                console.error('‚ùå DOCX generation failed:', error);
                resultDiv.innerHTML = `<div class="result error">‚ùå DOCX generation failed\n\nError: ${error.message}\nStack: ${error.stack}</div>`;
            }
        }

        function testWithSampleData() {
            document.getElementById('subject').value = 'Chess By Panchatantra';
            document.getElementById('summary').value = 'RVU clubs combined celebrate the event Chess By Panchatantra in the RV University Campus. This proposal requires administrative approval for successful execution.';
            document.getElementById('nfaType').value = 'reimbursement';
            document.getElementById('needBullets').value = 'yes';
            
            generateNFADocx();
        }

        function createTemplateParagraphs(content) {
            if (!content) return [];
            
            const paragraphs = [];
            const lines = content.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line) {
                    // Empty line
                    paragraphs.push(new Paragraph({
                        children: [new TextRun({ text: " ", size: 20, font: "Arial" })],
                        spacing: { after: 200 },
                    }));
                    continue;
                }
                
                // Clean the line to remove any problematic characters
                const cleanLine = cleanTextForXML(line);
                if (!cleanLine) continue;
                
                // Subject line
                if (cleanLine.toLowerCase().startsWith('subject:')) {
                    const subjectText = cleanLine.substring(8).trim();
                    paragraphs.push(new Paragraph({
                        children: [
                            new TextRun({
                                text: "Subject: ",
                                bold: true,
                                size: 20,
                                font: "Arial",
                            }),
                            new TextRun({
                                text: subjectText.replace(/[^\x20-\x7E]/g, ''),
                                size: 20,
                                font: "Arial",
                            }),
                        ],
                        alignment: AlignmentType.JUSTIFY,
                        spacing: { after: 200 },
                    }));
                    continue;
                }
                
                // Bullet points
                if (cleanLine.startsWith('‚Ä¢')) {
                    const bulletText = cleanLine.substring(1).trim();
                    paragraphs.push(new Paragraph({
                        children: [
                            new TextRun({
                                text: "‚Ä¢ ",
                                size: 20,
                                font: "Arial",
                            }),
                            new TextRun({
                                text: bulletText.replace(/[^\x20-\x7E]/g, ''),
                                size: 20,
                                font: "Arial",
                            }),
                        ],
                        alignment: AlignmentType.JUSTIFY,
                        spacing: { after: 200 },
                    }));
                    continue;
                }
                
                // Regular paragraphs
                paragraphs.push(new Paragraph({
                    children: [
                        new TextRun({
                            text: cleanLine.replace(/[^\x20-\x7E]/g, ''),
                            size: 20,
                            font: "Arial",
                        }),
                    ],
                    alignment: AlignmentType.JUSTIFY,
                    spacing: { after: 200 },
                }));
            }
            
            return paragraphs;
        }

        // Auto-run test on page load
        window.onload = function() {
            console.log('üîß Client-Side DOCX Generation Fix Loaded');
            console.log('Click "Test with Sample Data" to test the fix');
        };
    </script>
</body>
</html>
